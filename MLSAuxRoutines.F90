!-------------------------------------------------------

      subroutine inverseLU(a,c)
      use constants
      implicit none
      real(DP) :: a(4,4), c(4,4)
      real(DP) :: L(4,4), U(4,4)
      real(DP) :: b(4), d(4), x(4)
      real(DP) :: coeff
      integer i,j,k

      L = 0.0 ; U = 0.0 ; b = 0.0
      
      !forward elimination
      do k=1,3
       do i=k+1,4
            coeff=a(i,k)/a(k,k)
            L(i,k) = coeff
            do j=k+1,4
                  a(i,j)=a(i,j)-coeff*a(k,j)
            end do
       end do
      end do

      !prepare L U
      do i=1,4
       L(i,i) = 1.0
      end do
      do j=1,4
       do i=1,j
            U(i,j) = a(i,j)
       end do
      end do

      !compute columns of c
      do k=1,4
       b(k)=1.0
       d(1)=b(1)
        do i=2,4
        d(i)=b(i)
         do j=1,i-1
            d(i) = d(i)-L(i,j)*d(j)
         end do
        end do
       !solve ux=d with back subs.
       x(4)=d(4)/U(4,4)
       do i=3,1,-1
        x(i) = d(i)
        do j=4,i+1,-1
          x(i)=x(i)-U(i,j)*x(j)
        end do
        x(i) = x(i)/u(i,i)
       end do
      !fill solns of x(n) to k of C
      do i=1,4
            c(i,k)=x(i)
      end do
            b(k) = 0.0
      end do


      return
      end

      subroutine invert4(a,ia)
       implicit none
       real(8), intent(in) :: a (4,4)
       real(8), intent(out) :: ia (4,4)
       real(8) :: det_l, invdet

       det_l =  a(1,1)*(a(2,2)*(a(3,3)*a(4,4)-a(3,4)*a(4,3)) &
                  -a(2,3)*(a(3,2)*a(4,4)-a(3,4)*a(4,2)) &
                  +a(2,4)*(a(3,2)*a(4,3)-a(3,3)*a(4,2)))&
          -a(1,2)*(a(2,1)*(a(3,3)*a(4,4)-a(3,4)*a(4,3)) &
                  -a(2,3)*(a(3,1)*a(4,4)-a(3,4)*a(4,1)) &
                  +a(2,4)*(a(3,1)*a(4,3)-a(3,3)*a(4,1)))&
          +a(1,3)*(a(2,1)*(a(3,2)*a(4,4)-a(3,4)*a(4,2)) &
                  -a(2,2)*(a(3,1)*a(4,4)-a(3,4)*a(4,1)) &
                  +a(2,4)*(a(3,1)*a(4,2)-a(3,2)*a(4,1)))&
          -a(1,4)*(a(2,1)*(a(3,2)*a(4,3)-a(3,3)*a(4,2)) &
                  -a(2,2)*(a(3,1)*a(4,3)-a(3,3)*a(4,1)) &
                  +a(2,3)*(a(3,1)*a(4,2)-a(3,2)*a(4,1)))

      invdet = 1.0d0/det_l

       ia(1,1) =  (a(2,2)*(a(3,3)*a(4,4)-a(3,4)*a(4,3))-a(2,3)* &
      (a(3,2)*a(4,4)-a(3,4)*a(4,2))+a(2,4)*(a(3,2)*a(4,3)-a(3,3)*a(4,2))) * invdet
       ia(2,1) = (-a(2,1)*(a(3,3)*a(4,4)-a(3,4)*a(4,3))+a(2,3)* &
      (a(3,1)*a(4,4)-a(3,4)*a(4,1))-a(2,4)*(a(3,1)*a(4,3)-a(3,3)*a(4,1))) * invdet
       ia(3,1) =  (a(2,1)*(a(3,2)*a(4,4)-a(3,4)*a(4,2))-a(2,2)* &
      (a(3,1)*a(4,4)-a(3,4)*a(4,1))+a(2,4)*(a(3,1)*a(4,2)-a(3,2)*a(4,1))) * invdet
       ia(4,1) = (-a(2,1)*(a(3,2)*a(4,3)-a(3,3)*a(4,2))+a(2,2)* &
      (a(3,1)*a(4,3)-a(3,3)*a(4,1))-a(2,3)*(a(3,1)*a(4,2)-a(3,2)*a(4,1))) * invdet

       ia(1,2) = (-a(1,2)*(a(3,3)*a(4,4)-a(3,4)*a(4,3))+a(1,3)* &
      (a(3,2)*a(4,4)-a(3,4)*a(4,2))-a(1,4)*(a(3,2)*a(4,3)-a(3,3)*a(4,2))) * invdet
       ia(2,2) =  (a(1,1)*(a(3,3)*a(4,4)-a(3,4)*a(4,3))-a(1,3)* &
      (a(3,1)*a(4,4)-a(3,4)*a(4,1))+a(1,4)*(a(3,1)*a(4,3)-a(3,3)*a(4,1))) * invdet
       ia(3,2) = (-a(1,1)*(a(3,2)*a(4,4)-a(3,4)*a(4,2))+a(1,2)* &
      (a(3,1)*a(4,4)-a(3,4)*a(4,1))-a(1,4)*(a(3,1)*a(4,2)-a(3,2)*a(4,1))) * invdet
       ia(4,2) =  (a(1,1)*(a(3,2)*a(4,3)-a(3,3)*a(4,2))-a(1,2)* &
      (a(3,1)*a(4,3)-a(3,3)*a(4,1))+a(1,3)*(a(3,1)*a(4,2)-a(3,2)*a(4,1))) * invdet

       ia(1,3) =  (a(1,2)*(a(2,3)*a(4,4)-a(2,4)*a(4,3))-a(1,3)* &
      (a(2,2)*a(4,4)-a(2,4)*a(4,2))+a(1,4)*(a(2,2)*a(4,3)-a(2,3)*a(4,2))) * invdet
       ia(2,3) = (-a(1,1)*(a(2,3)*a(4,4)-a(2,4)*a(4,3))+a(1,3)* &
      (a(2,1)*a(4,4)-a(2,4)*a(4,1))-a(1,4)*(a(2,1)*a(4,3)-a(2,3)*a(4,1))) * invdet
       ia(3,3) =  (a(1,1)*(a(2,2)*a(4,4)-a(2,4)*a(4,2))-a(1,2)* &
      (a(2,1)*a(4,4)-a(2,4)*a(4,1))+a(1,4)*(a(2,1)*a(4,2)-a(2,2)*a(4,1))) * invdet
       ia(4,3) = (-a(1,1)*(a(2,2)*a(4,3)-a(2,3)*a(4,2))+a(1,2)* &
      (a(2,1)*a(4,3)-a(2,3)*a(4,1))-a(1,3)*(a(2,1)*a(4,2)-a(2,2)*a(4,1))) * invdet

       ia(1,4) = (-a(1,2)*(a(2,3)*a(3,4)-a(2,4)*a(3,3))+a(1,3)* &
      (a(2,2)*a(3,4)-a(2,4)*a(3,2))-a(1,4)*(a(2,2)*a(3,3)-a(2,3)*a(3,2))) * invdet
       ia(2,4) =  (a(1,1)*(a(2,3)*a(3,4)-a(2,4)*a(3,3))-a(1,3)* &
      (a(2,1)*a(3,4)-a(2,4)*a(3,1))+a(1,4)*(a(2,1)*a(3,3)-a(2,3)*a(3,1))) * invdet
       ia(3,4) = (-a(1,1)*(a(2,2)*a(3,4)-a(2,4)*a(3,2))+a(1,2)* &
      (a(2,1)*a(3,4)-a(2,4)*a(3,1))-a(1,4)*(a(2,1)*a(3,2)-a(2,2)*a(3,1))) * invdet
       ia(4,4) =  (a(1,1)*(a(2,2)*a(3,3)-a(2,3)*a(3,2))-a(1,2)* &
      (a(2,1)*a(3,3)-a(2,3)*a(3,1))+a(1,3)*(a(2,1)*a(3,2)-a(2,2)*a(3,1))) * invdet


      return
      end subroutine invert4
